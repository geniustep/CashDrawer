# خطة تطوير GeniusStep CashDrawer Agent

## تحليل الوضع الحالي

### نقاط القوة
- بنية بسيطة ومركّزة (~30-50 سطر لكل ملف)
- استخدام Pydantic للتحقق من صحة الإعدادات
- إعادة اتصال تلقائي لـ WebSocket
- ملف EXE مستقل لا يحتاج تثبيت Python
- API محلي فقط (127.0.0.1) للأمان

### نقاط الضعف
| المشكلة | الملف | التأثير |
|---------|-------|---------|
| لا يوجد واجهة مستخدم HTML | web_ui.py | المستخدم يحتاج أداة خارجية للتهيئة |
| لا يوجد logging حقيقي | كل الملفات | print() فقط - لا ملفات سجل |
| لا يوجد تحقق من المدخلات في POST /config | web_ui.py:20 | يقبل أي payload بدون تصفية |
| Config يُقرأ من الملف في كل رسالة WebSocket | ws_client.py:11 | I/O غير ضروري |
| لا يوجد health check endpoint | web_ui.py | صعوبة مراقبة حالة الخدمة |
| لا يوجد نظام تشغيل كخدمة Windows | app.py | يحتاج نافذة console مفتوحة دائماً |
| Token مكشوف عبر GET /config | web_ui.py:17 | مخاطر أمنية |
| خطأ إملائي في عنوان FastAPI | web_ui.py:7 | "GeniuStep" بدل "GeniusStep" |

---

## المرحلة 1: إصلاحات حرجة

| # | المهمة | التفاصيل | الملف |
|---|--------|---------|-------|
| 1.1 | إصلاح الخطأ الإملائي | "GeniuStep" → "GeniusStep" | web_ui.py:7 |
| 1.2 | نظام Logging حقيقي | استبدال print() بـ logging + RotatingFileHandler | كل الملفات |
| 1.3 | تحقق من المدخلات | Pydantic model لـ POST /config بدل dict مفتوح | web_ui.py:20 |
| 1.4 | إخفاء Token | إرجاع آخر 4 أحرف فقط من device_token في GET /config | web_ui.py:17 |
| 1.5 | Cache للـ Config | قراءة Config مرة واحدة + reload عند التغيير فقط | ws_client.py |

## المرحلة 2: تحسينات وظيفية

| # | المهمة | التفاصيل |
|---|--------|---------|
| 2.1 | Health Check Endpoint | GET /health يرجع حالة WebSocket + آخر أمر + uptime |
| 2.2 | تاريخ العمليات | حفظ آخر 100 عملية فتح درج + endpoint GET /history |
| 2.3 | أوامر WebSocket إضافية | دعم PING، GET_STATUS، UPDATE_CONFIG |
| 2.4 | إعادة اتصال ذكية | Exponential backoff (3s → 6s → 12s → 30s max) |
| 2.5 | تشغيل كخدمة Windows | دعم --install-service عبر pywin32 ServiceFramework |
| 2.6 | التحديث التلقائي | فحص وتحميل نسخ جديدة من السيرفر |
| 2.7 | دعم أدراج متعددة | ربط أكثر من طابعة/درج بنفس الوكيل |

## المرحلة 3: الأمان والاستقرار

| # | المهمة | التفاصيل |
|---|--------|---------|
| 3.1 | تشفير Config | تشفير device_token في ملف JSON |
| 3.2 | Rate Limiting | حد أقصى 10 أوامر/دقيقة لفتح الدرج |
| 3.3 | API Key للـ REST | حماية endpoints المحلية بمفتاح |
| 3.4 | Graceful Shutdown | إغلاق نظيف لـ WebSocket و API |
| 3.5 | Watchdog | مراقبة ذاتية وإعادة تشغيل المكونات المتعطلة |

---

## المرحلة 4: واجهة ويب مدمجة (أعلى أولوية)

### المشكلة
المشروع حالياً لا يملك أي واجهة مستخدم مرئية - فقط REST API endpoints.

### الحل
صفحة HTML واحدة مدمجة في FastAPI تُقدَّم على `/`

### مكونات الواجهة

| المكوّن | الوظيفة |
|---------|---------|
| Status Bar | عرض حالة الاتصال لحظياً (polling /health كل 5 ثوانٍ) |
| Printer Selector | قائمة منسدلة تسحب من GET /printers |
| Config Form | نموذج إعدادات مع تحقق client-side |
| Test Button | اختبار فتح الدرج مع feedback مرئي |
| Activity Log | سجل آخر 50 عملية مع تحديث تلقائي |
| Toast Notifications | إشعارات نجاح/فشل |

### التقنيات المقترحة
- HTML/CSS/JS: Vanilla أو Alpine.js (خفيف، بدون build step)
- التصميم: Tailwind CSS via CDN
- الأيقونات: Heroicons أو Lucide (SVG)
- API: Fetch API
- Real-time: Polling كل 5s أو SSE

## المرحلة 5: تحسينات UX متقدمة

| # | التحسين | الوصف |
|---|---------|-------|
| 5.1 | Setup Wizard | معالج إعداد أول من 3 خطوات |
| 5.2 | مؤشرات بصرية | نقطة خضراء/حمراء + رسوم متحركة |
| 5.3 | رسائل خطأ مفهومة | رسائل عربية واضحة بدل رسائل تقنية |
| 5.4 | الوضع المظلم/الفاتح | تبديل تلقائي أو يدوي |
| 5.5 | دعم RTL كامل | واجهة عربية/إنجليزية مع تبديل اللغة |
| 5.6 | System Tray Icon | أيقونة في شريط المهام مع قائمة سريعة |
| 5.7 | إشعارات Windows | Toast notification عند فقد الاتصال |
| 5.8 | صفحة تشخيص | فحص شامل لكل المكونات |
| 5.9 | Responsive Design | تعمل على الموبايل عبر الشبكة المحلية |

## المرحلة 6: تجربة التثبيت

| # | التحسين | الوصف |
|---|---------|-------|
| 6.1 | Windows Installer | مُثبّت MSI/NSIS مع اختصار + خدمة |
| 6.2 | فتح المتصفح تلقائياً | فتح الواجهة عند أول تشغيل |
| 6.3 | Splash Screen | شاشة تحميل أثناء البدء |
| 6.4 | تحديث تلقائي | فحص إصدار جديد + تحديث بنقرة |

---

## ترتيب الأولويات

### أولوية عالية
1. واجهة ويب مدمجة (المرحلة 4)
2. نظام Logging (1.2)
3. Health Check (2.1)
4. إصلاحات حرجة (1.1-1.5)

### أولوية متوسطة
5. سجل العمليات (2.2)
6. Setup Wizard (5.1)
7. رسائل خطأ واضحة (5.3)
8. خدمة Windows (2.5)

### أولوية منخفضة
9. System Tray (5.6)
10. أدراج متعددة (2.7)
11. مُثبّت MSI (6.1)
12. تحديث تلقائي (6.4)
